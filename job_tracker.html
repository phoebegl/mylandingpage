<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Internship Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase debug log level
        setLogLevel('Debug');

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId;
        const geminiApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=`;
        const applicationStatuses = ['Applied', 'Interviewing', 'Offer', 'Rejected'];

        // Translations object for UI elements
        const translations = {
            'en': {
                'mainTitle': 'Application Tracker',
                'subTitle': 'Stay organized. Track your applications, deadlines, and interviews.',
                'addButton': 'Add New Application',
                'userIdDisplay': 'User ID:',
                'tableCompany': 'Company',
                'tablePosition': 'Position',
                'tableAppliedOn': 'Applied On',
                'tableStatus': 'Status',
                'tableDeadline': 'Deadline',
                'tableContact': 'Contact',
                'tableActions': 'Actions',
                'emptyTable': 'No applications added yet.',
                'interviewQuestions': 'Interview Questions ✨',
                'followUpEmail': 'Follow-up Email ✨',
                'coverLetterButton': 'Cover Letter ✨',
                'salaryTipsButton': 'Salary Tips ✨',
                'companyResearchButton': 'Company Research ✨',
                'deleteButton': 'Delete',
                'modalAddTitle': 'Add New Application',
                'modalEditTitle': 'Edit Application',
                'modalCompanyName': 'Company Name',
                'modalPositionTitle': 'Position Title',
                'modalAppliedDate': 'Date Applied',
                'modalStatus': 'Status',
                'modalDeadline': 'Deadline (Optional)',
                'modalContactPerson': 'Contact Person (Optional)',
                'modalCancel': 'Cancel',
                'modalSave': 'Save',
                'modalConfirmTitle': 'Are you sure?',
                'modalConfirmText': 'This action cannot be undone.',
                'modalConfirmCancel': 'Cancel',
                'modalConfirmDelete': 'Delete',
                'geminiModalTitle': 'Generated Content',
                'generatingContent': 'Generating content... Please wait.',
                'generationError': 'An error occurred while generating content. Please try again.',
                'emailDrafting': 'Drafting email... Please wait.',
                'draftingError': 'An error occurred while drafting the email. Please try again.',
                'coverLetterDrafting': 'Drafting cover letter... Please wait.',
                'coverLetterError': 'An error occurred while drafting the cover letter. Please try again.',
                'tipsGenerating': 'Generating tips... Please wait.',
                'tipsError': 'An error occurred while generating tips. Please try again.',
                'companyResearchGenerating': 'Generating company research... Please wait.',
                'companyResearchError': 'An error occurred while generating company research. Please try again.',
                'geminiClose': 'Close',
                'statusApplied': 'Applied',
                'statusInterviewing': 'Interviewing',
                'statusOffer': 'Offer',
                'statusRejected': 'Rejected',
                'statusDefault': 'N/A',
                'tableType': 'Type',
                'modalType': 'Application Type',
                'typeInternship': 'Internship',
                'typeJob': 'Job',
                'premiumToggle': 'Premium',
                'premiumFeatures': 'Premium Features',
                'resumeAnalysis': 'Resume Analysis ✨',
                'interviewPrep': 'Interview Prep ✨',
                'notPremium': 'Upgrade to Premium to unlock this feature!'
            },
            'el': {
                'mainTitle': 'Ανιχνευτής Αιτήσεων',
                'subTitle': 'Μείνετε οργανωμένοι. Παρακολουθήστε τις αιτήσεις, τις προθεσμίες και τις συνεντεύξεις σας.',
                'addButton': 'Προσθήκη Νέας Αίτησης',
                'userIdDisplay': 'Αναγνωριστικό Χρήστη:',
                'tableCompany': 'Εταιρεία',
                'tablePosition': 'Θέση',
                'tableAppliedOn': 'Ημερομηνία Αίτησης',
                'tableStatus': 'Κατάσταση',
                'tableDeadline': 'Προθεσμία',
                'tableContact': 'Υπεύθυνος Επικοινωνίας',
                'tableActions': 'Ενέργειες',
                'emptyTable': 'Δεν έχουν προστεθεί αιτήσεις ακόμα.',
                'interviewQuestions': 'Ερωτήσεις Συνέντευξης ✨',
                'followUpEmail': 'Email Παρακολούθησης ✨',
                'coverLetterButton': 'Συνοδευτική Επιστολή ✨',
                'salaryTipsButton': 'Συμβουλές Διαπραγμάτευσης ✨',
                'companyResearchButton': 'Εταιρική Έρευνα ✨',
                'deleteButton': 'Διαγραφή',
                'modalAddTitle': 'Προσθήκη Νέας Αίτησης',
                'modalEditTitle': 'Επεξεργασία Αίτησης',
                'modalCompanyName': 'Όνομα Εταιρείας',
                'modalPositionTitle': 'Τίτλος Θέσης',
                'modalAppliedDate': 'Ημερομηνία Αίτησης',
                'modalStatus': 'Κατάσταση',
                'modalDeadline': 'Προθεσμία (Προαιρετικό)',
                'modalContactPerson': 'Υπεύθυνος Επικοινωνίας (Προαιρετικό)',
                'modalCancel': 'Ακύρωση',
                'modalSave': 'Αποθήκευση',
                'modalConfirmTitle': 'Είστε σίγουροι;',
                'modalConfirmText': 'Αυτή η ενέργεια δεν μπορεί να αναιρεθεί.',
                'modalConfirmCancel': 'Ακύρωση',
                'modalConfirmDelete': 'Διαγραφή',
                'geminiModalTitle': 'Δημιουργημένο Περιεχόμενο',
                'generatingContent': 'Δημιουργία περιεχομένου... Παρακαλώ περιμένετε.',
                'generationError': 'Παρουσιάστηκε σφάλμα κατά τη δημιουργία περιεχομένου. Παρακαλώ δοκιμάστε ξανά.',
                'emailDrafting': 'Σύνταξη email... Παρακαλώ περιμένετε.',
                'draftingError': 'Παρουσιάστηκε σφάλμα κατά τη σύνταξη του email. Παρακαλώ δοκιμάστε ξανά.',
                'coverLetterDrafting': 'Σύνταξη συνοδευτικής επιστολής... Παρακαλώ περιμένετε.',
                'coverLetterError': 'Παρουσιάστηκε σφάλμα κατά τη σύνταξη της συνοδευτικής επιστολής. Παρακαλώ δοκιμάστε ξανά.',
                'tipsGenerating': 'Δημιουργία συμβουλών... Παρακαλώ περιμένετε.',
                'tipsError': 'Παρουσιάστηκε σφάλμα κατά τη δημιουργία συμβουλών. Παρακαλώ δοκιμάστε ξανά.',
                'companyResearchGenerating': 'Δημιουργία εταιρικής έρευνας... Παρακαλώ περιμένετε.',
                'companyResearchError': 'Παρουσιάστηκε σφάλμα κατά τη δημιουργία εταιρικής έρευνας. Παρακαλώ δοκιμάστε ξανά.',
                'geminiClose': 'Κλείσιμο',
                'statusApplied': 'Υποβλήθηκε',
                'statusInterviewing': 'Σε Συνέντευξη',
                'statusOffer': 'Προσφορά',
                'statusRejected': 'Απορρίφθηκε',
                'statusDefault': 'Δεν Υπάρχει',
                'tableType': 'Τύπος',
                'modalType': 'Τύπος Αίτησης',
                'typeInternship': 'Πρακτική Άσκηση',
                'typeJob': 'Δουλειά',
                'premiumToggle': 'Premium',
                'premiumFeatures': 'Premium Λειτουργίες',
                'resumeAnalysis': 'Ανάλυση Βιογραφικού ✨',
                'interviewPrep': 'Προετοιμασία Συνέντευξης ✨',
                'notPremium': 'Αναβαθμίστε σε Premium για να ξεκλειδώσετε αυτή τη λειτουργία!'
            }
        };

        function setLanguage(lang) {
            localStorage.setItem('language', lang);
            const elements = document.querySelectorAll('[data-i18n]');
            elements.forEach(el => {
                const keys = el.dataset.i18n.split('.');
                let text = translations[lang];
                keys.forEach(key => {
                    text = text[key];
                });
                if (el.tagName === 'INPUT' || el.tagName === 'BUTTON' || el.tagName === 'OPTION') {
                    if (el.type === 'date') {
                        // Don't translate date input placeholder
                    } else if (el.dataset.i18n.includes('placeholder')) {
                        el.placeholder = text;
                    } else {
                        el.textContent = text;
                    }
                } else if (el.tagName === 'SELECT') {
                    // Do nothing, options handled separately
                } else {
                    el.textContent = text;
                }
            });

            // Update select options separately
            const statusSelects = document.querySelectorAll('.status-select');
            statusSelects.forEach(select => {
                const currentStatus = select.value;
                select.innerHTML = applicationStatuses.map(status => {
                    const translatedStatus = translations[lang]['status' + status];
                    return `<option value="${status}" ${status === currentStatus ? 'selected' : ''}>${translatedStatus}</option>`;
                }).join('');
            });

            const modalStatusSelect = document.getElementById('status');
            if(modalStatusSelect) {
                 modalStatusSelect.innerHTML = applicationStatuses.map(status => {
                    const translatedStatus = translations[lang]['status' + status];
                    return `<option value="${status}">${translatedStatus}</option>`;
                }).join('');
            }
            
            const modalTypeSelect = document.getElementById('applicationType');
            if(modalTypeSelect) {
                 const currentType = modalTypeSelect.value;
                 modalTypeSelect.innerHTML = `
                    <option value="Internship" ${currentType === 'Internship' ? 'selected' : ''} data-i18n="typeInternship">${translations[lang]['typeInternship']}</option>
                    <option value="Job" ${currentType === 'Job' ? 'selected' : ''} data-i18n="typeJob">${translations[lang]['typeJob']}</option>
                 `;
            }
        }

        window.onload = async function() {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    // Set initial language from local storage or default to English
                    const savedLang = localStorage.getItem('language') || 'el';
                    document.getElementById('language-select').value = savedLang;
                    setLanguage(savedLang);

                    document.getElementById('language-select').addEventListener('change', (e) => {
                        setLanguage(e.target.value);
                    });
                    
                    document.getElementById('premium-toggle').addEventListener('change', (e) => {
                         localStorage.setItem('isPremium', e.target.checked);
                         renderApplications(currentApplications); // Re-render to show/hide buttons
                     });

                    // Sign in with custom token or anonymously
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }

                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            const userIdText = translations[localStorage.getItem('language') || 'el']['userIdDisplay'] + ' ' + userId;
                            document.getElementById('user-id-display').textContent = userIdText;
                            document.getElementById('add-application-button').disabled = false;
                            
                            // Start listening for applications once authenticated
                            startListeningForApplications();
                        } else {
                            console.log("No user is signed in.");
                            document.getElementById('user-id-display').textContent = translations[localStorage.getItem('language') || 'el']['userIdDisplay'] + ' N/A';
                            document.getElementById('add-application-button').disabled = true;
                        }
                    });

                    // Set up event listeners for modals
                    document.getElementById('add-application-button').addEventListener('click', showAddModal);
                    document.getElementById('cancel-button').addEventListener('click', hideAddModal);
                    document.getElementById('modal-form').addEventListener('submit', handleFormSubmit);
                    document.getElementById('gemini-modal-close').addEventListener('click', hideGeminiModal);
                    
                } else {
                    console.error("Firebase config is missing. Please check the environment setup.");
                }
            } catch (e) {
                console.error("Error during Firebase initialization:", e);
            }
        };

        let currentApplications = [];

        function startListeningForApplications() {
            if (!db || !userId) {
                console.error("Database or User ID not ready.");
                return;
            }

            const applicationsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'applications');
            
            onSnapshot(applicationsCollectionRef, (snapshot) => {
                currentApplications = [];
                snapshot.forEach((doc) => {
                    currentApplications.push({ id: doc.id, ...doc.data() });
                });
                renderApplications(currentApplications);
            }, (error) => {
                console.error("Error getting applications:", error);
            });
        }

        function renderApplications(applications) {
            const tableBody = document.getElementById('applications-table-body');
            tableBody.innerHTML = '';
            applications.sort((a, b) => new Date(b.applicationDate) - new Date(a.applicationDate));

            const lang = localStorage.getItem('language') || 'el';
            const isPremium = document.getElementById('premium-toggle').checked;

            if (applications.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="8" class="py-4 text-center text-gray-500">${translations[lang]['emptyTable']}</td></tr>`;
                return;
            }
            
            applications.forEach(app => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const statusColor = getStatusColor(app.status);
                const statusSelectOptions = applicationStatuses.map(status => {
                    const translatedStatus = translations[lang]['status' + status];
                    return `<option value="${status}" ${app.status === status ? 'selected' : ''}>${translatedStatus}</option>`;
                }).join('');

                const translatedType = translations[lang][app.applicationType === 'Job' ? 'typeJob' : 'typeInternship'];

                // Check for premium status to enable/disable buttons
                const premiumButtonClass = isPremium ? '' : 'opacity-50 cursor-not-allowed';
                const premiumButtonText = isPremium ? '' : `title="${translations[lang]['notPremium']}"`;
                const isPremiumDisabled = isPremium ? '' : 'disabled';

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${app.companyName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${app.positionTitle}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${translatedType}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${app.applicationDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <select data-id="${app.id}" class="status-select rounded-md p-1 border ${statusColor} text-white">
                            ${statusSelectOptions}
                        </select>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${app.deadline || translations[lang]['statusDefault']}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${app.contactPerson || translations[lang]['statusDefault']}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium flex items-center justify-end space-x-2">
                        <button data-id="${app.id}" class="generate-questions-btn px-3 py-1 bg-violet-600 text-white font-semibold rounded-full hover:bg-violet-700 transition-colors text-xs ${premiumButtonClass}" ${premiumButtonText} ${isPremiumDisabled} data-i18n="interviewQuestions">${translations[lang]['interviewQuestions']}</button>
                        <button data-id="${app.id}" class="draft-email-btn px-3 py-1 bg-emerald-600 text-white font-semibold rounded-full hover:bg-emerald-700 transition-colors text-xs ${premiumButtonClass}" ${premiumButtonText} ${isPremiumDisabled} data-i18n="followUpEmail">${translations[lang]['followUpEmail']}</button>
                        <button data-id="${app.id}" class="generate-cover-letter-btn px-3 py-1 bg-sky-600 text-white font-semibold rounded-full hover:bg-sky-700 transition-colors text-xs ${premiumButtonClass}" ${premiumButtonText} ${isPremiumDisabled} data-i18n="coverLetterButton">${translations[lang]['coverLetterButton']}</button>
                        <button data-id="${app.id}" class="generate-salary-tips-btn px-3 py-1 bg-amber-600 text-white font-semibold rounded-full hover:bg-amber-700 transition-colors text-xs ${premiumButtonClass}" ${premiumButtonText} ${isPremiumDisabled} data-i18n="salaryTipsButton">${translations[lang]['salaryTipsButton']}</button>
                        <button data-id="${app.id}" class="generate-company-research-btn px-3 py-1 bg-teal-600 text-white font-semibold rounded-full hover:bg-teal-700 transition-colors text-xs ${premiumButtonClass}" ${premiumButtonText} ${isPremiumDisabled} data-i18n="companyResearchButton">${translations[lang]['companyResearchButton']}</button>
                        <button data-id="${app.id}" class="delete-button text-red-600 hover:text-red-900 ml-2" data-i18n="deleteButton">${translations[lang]['deleteButton']}</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // Add event listeners for status change and delete
            document.querySelectorAll('.status-select').forEach(select => {
                select.addEventListener('change', (e) => {
                    const id = e.target.dataset.id;
                    const newStatus = e.target.value;
                    updateApplicationStatus(id, newStatus, e.target);
                });
            });

            document.querySelectorAll('.delete-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    showConfirmModal(id);
                });
            });

            // Add event listeners for new Gemini buttons
            document.querySelectorAll('.generate-questions-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = e.target.dataset.id;
                    const docRef = doc(db, 'artifacts', appId, 'users', userId, 'applications', id);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        handleGenerateQuestions(data, id);
                    }
                });
            });

            document.querySelectorAll('.draft-email-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = e.target.dataset.id;
                    const docRef = doc(db, 'artifacts', appId, 'users', userId, 'applications', id);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        handleDraftEmail(data, id);
                    }
                });
            });
            
            document.querySelectorAll('.generate-cover-letter-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = e.target.dataset.id;
                    const docRef = doc(db, 'artifacts', appId, 'users', userId, 'applications', id);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        handleGenerateCoverLetter(data, id);
                    }
                });
            });
            
            document.querySelectorAll('.generate-salary-tips-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = e.target.dataset.id;
                    const docRef = doc(db, 'artifacts', appId, 'users', userId, 'applications', id);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        handleGenerateNegotiationTips(data, id);
                    }
                });
            });
            
            document.querySelectorAll('.generate-company-research-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = e.target.dataset.id;
                    const docRef = doc(db, 'artifacts', appId, 'users', userId, 'applications', id);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        handleGenerateCompanyResearch(data, id);
                    }
                });
            });
        }

        async function updateApplicationStatus(id, newStatus, element) {
            const docRef = doc(db, 'artifacts', appId, 'users', userId, 'applications', id);
            try {
                await updateDoc(docRef, { status: newStatus });
                const newColor = getStatusColor(newStatus);
                element.className = `status-select rounded-md p-1 border ${newColor} text-white`;
                console.log("Status updated successfully.");
            } catch (e) {
                console.error("Error updating status:", e);
            }
        }

        async function deleteApplication(id) {
            const docRef = doc(db, 'artifacts', appId, 'users', userId, 'applications', id);
            try {
                await deleteDoc(docRef);
                console.log("Application deleted successfully.");
            } catch (e) {
                console.error("Error deleting application:", e);
            }
        }

        function showAddModal() {
            const lang = localStorage.getItem('language') || 'el';
            document.getElementById('modal-title').textContent = translations[lang]['modalAddTitle'];
            document.getElementById('modal-form').reset();
            setLanguage(lang); // Re-apply translations for modal fields
            document.getElementById('modal-container').classList.remove('hidden');
        }

        function showConfirmModal(id) {
            document.getElementById('confirm-modal-container').classList.remove('hidden');
            document.getElementById('confirm-button').onclick = () => {
                deleteApplication(id);
                hideConfirmModal();
            };
            document.getElementById('cancel-confirm-button').onclick = hideConfirmModal;
        }

        function hideAddModal() {
            document.getElementById('modal-container').classList.add('hidden');
        }

        function hideConfirmModal() {
            document.getElementById('confirm-modal-container').classList.add('hidden');
        }

        function showGeminiModal(title, content) {
            document.getElementById('gemini-modal-title').textContent = title;
            document.getElementById('gemini-modal-content').value = content;
            document.getElementById('gemini-modal-container').classList.remove('hidden');
        }

        function hideGeminiModal() {
            document.getElementById('gemini-modal-container').classList.add('hidden');
            document.getElementById('gemini-modal-content').value = '';
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const applicationData = {
                companyName: formData.get('companyName'),
                positionTitle: formData.get('positionTitle'),
                applicationType: formData.get('applicationType'),
                applicationDate: formData.get('applicationDate'),
                status: formData.get('status'),
                deadline: formData.get('deadline'),
                contactPerson: formData.get('contactPerson'),
            };

            const collectionRef = collection(db, 'artifacts', appId, 'users', userId, 'applications');
            try {
                await addDoc(collectionRef, applicationData);
                console.log("Application added successfully.");
                hideAddModal();
            } catch (e) {
                console.error("Error adding document:", e);
            }
        }
        
        function getStatusColor(status) {
            switch (status) {
                case 'Applied':
                    return 'bg-blue-500';
                case 'Interviewing':
                    return 'bg-yellow-500';
                case 'Offer':
                    return 'bg-green-500';
                case 'Rejected':
                    return 'bg-red-500';
                default:
                    return 'bg-gray-500';
            }
        }

        async function fetchWithBackoff(url, options, retries = 3, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                if (retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return fetchWithBackoff(url, options, retries - 1, delay * 2);
                } else {
                    throw error;
                }
            }
        }

        async function callGeminiApi(prompt, lang, tools = undefined, systemPrompt = undefined) {
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
            };
            if (tools) {
                payload.tools = tools;
            }
            if (systemPrompt) {
                payload.systemInstruction = {
                    parts: [{ text: systemPrompt }]
                };
            }
            const result = await fetchWithBackoff(geminiApiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });
            return result.candidates?.[0]?.content?.parts?.[0]?.text || translations[lang]['generationError'];
        }

        async function handleGenerateQuestions(data, docId) {
            const lang = localStorage.getItem('language') || 'el';
            showGeminiModal(translations[lang]['interviewQuestions'], translations[lang]['generatingContent']);
            try {
                const type = data.applicationType || 'Internship';
                const prompt = `Generate 5 common interview questions for a ${data.positionTitle} ${type === 'Job' ? 'job' : 'internship'} at ${data.companyName}. Include answers for each question. The questions and answers should be in ${lang === 'el' ? 'Greek' : 'English'}.`;
                const generatedText = await callGeminiApi(prompt, lang);
                await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'applications', docId), { interviewQuestions: generatedText });
                showGeminiModal(translations[lang]['interviewQuestions'], generatedText);
            } catch (e) {
                console.error("Error generating or saving interview questions:", e);
                document.getElementById('gemini-modal-content').value = translations[lang]['generationError'];
            }
        }

        async function handleDraftEmail(data, docId) {
            const lang = localStorage.getItem('language') || 'el';
            showGeminiModal(translations[lang]['followUpEmail'], translations[lang]['emailDrafting']);
            try {
                const type = data.applicationType || 'Internship';
                const prompt = `Draft a polite and professional follow-up email. The email is for a ${data.positionTitle} ${type === 'Job' ? 'job' : 'internship'} at ${data.companyName}. The recipient's name is ${data.contactPerson || '[Recipient Name]'}. The subject line should be professional. The body should briefly express continued interest and inquire about the status of the application. Keep it concise. The email should be in ${lang === 'el' ? 'Greek' : 'English'}.`;
                const generatedText = await callGeminiApi(prompt, lang);
                await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'applications', docId), { followUpEmail: generatedText });
                showGeminiModal(translations[lang]['followUpEmail'], generatedText);
            } catch (e) {
                console.error("Error generating or saving email draft:", e);
                document.getElementById('gemini-modal-content').value = translations[lang]['draftingError'];
            }
        }
        
        async function handleGenerateCoverLetter(data, docId) {
            const lang = localStorage.getItem('language') || 'el';
            showGeminiModal(translations[lang]['coverLetterButton'], translations[lang]['coverLetterDrafting']);
            try {
                const type = data.applicationType || 'Internship';
                const prompt = `Draft a professional cover letter for a ${data.positionTitle} ${type === 'Job' ? 'job' : 'internship'} at ${data.companyName}. The letter should express my interest and highlight my qualifications. Do not include personal details, but leave placeholders for them like [Your Name], [Your Contact Information], and [Recipient Name]. The letter should be in ${lang === 'el' ? 'Greek' : 'English'}.`;
                const generatedText = await callGeminiApi(prompt, lang);
                await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'applications', docId), { coverLetter: generatedText });
                showGeminiModal(translations[lang]['coverLetterButton'], generatedText);
            } catch (e) {
                console.error("Error generating or saving cover letter:", e);
                document.getElementById('gemini-modal-content').value = translations[lang]['coverLetterError'];
            }
        }

        async function handleGenerateNegotiationTips(data, docId) {
            const lang = localStorage.getItem('language') || 'el';
            showGeminiModal(translations[lang]['salaryTipsButton'], translations[lang]['tipsGenerating']);
            try {
                const type = data.applicationType || 'Internship';
                const prompt = `Provide 5 key tips for negotiating salary or compensation for a ${data.positionTitle} ${type === 'Job' ? 'job' : 'internship'} at ${data.companyName}. The tips should be concise and actionable, and should be in ${lang === 'el' ? 'Greek' : 'English'}.`;
                const generatedText = await callGeminiApi(prompt, lang);
                await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'applications', docId), { salaryTips: generatedText });
                showGeminiModal(translations[lang]['salaryTipsButton'], generatedText);
            } catch (e) {
                console.error("Error generating or saving tips:", e);
                document.getElementById('gemini-modal-content').value = translations[lang]['tipsError'];
            }
        }

        async function handleGenerateCompanyResearch(data, docId) {
            const lang = localStorage.getItem('language') || 'el';
            showGeminiModal(translations[lang]['companyResearchButton'], translations[lang]['companyResearchGenerating']);
            try {
                const query = lang === 'el' ? `Τελευταία νέα για την εταιρεία ${data.companyName}` : `Recent news for ${data.companyName}`;
                const systemPrompt = `You are a helpful assistant for interview preparation. Your task is to extract key information from web search results and provide a concise, single-paragraph summary of the company's recent activities and culture. Respond in ${lang === 'el' ? 'Greek' : 'English'}.`;
                
                const generatedText = await callGeminiApi(
                    query, 
                    lang, 
                    [{"google_search": {}}], 
                    systemPrompt
                );

                await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'applications', docId), { companyResearch: generatedText });
                showGeminiModal(translations[lang]['companyResearchButton'], generatedText);
            } catch (e) {
                console.error("Error generating or saving company research:", e);
                document.getElementById('gemini-modal-content').value = translations[lang]['companyResearchError'];
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal {
            background-color: rgba(0, 0, 0, 0.5);
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4 sm:p-6">
    <div class="bg-white rounded-2xl shadow-xl overflow-hidden w-full max-w-7xl p-6 sm:p-8 space-y-6">
        <header class="flex flex-col sm:flex-row justify-between items-center mb-6 border-b pb-4">
            <div class="text-center sm:text-left">
                <h1 class="text-4xl font-extrabold text-gray-800" data-i18n="mainTitle">Application Tracker</h1>
                <p class="mt-2 text-lg text-gray-500" data-i18n="subTitle">Stay organized. Track your applications, deadlines, and interviews.</p>
            </div>
            <div class="mt-4 sm:mt-0 flex flex-col items-center">
                <select id="language-select" class="px-4 py-2 mb-2 rounded-md border border-gray-300">
                    <option value="en">English</option>
                    <option value="el">Ελληνικά</option>
                </select>
                <div class="flex items-center space-x-2">
                    <label for="premium-toggle" class="text-sm text-gray-500" data-i18n="premiumToggle">Premium</label>
                    <input type="checkbox" id="premium-toggle" class="toggle-switch form-checkbox h-4 w-4 text-indigo-600 rounded">
                </div>
                <button id="add-application-button" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-full shadow-lg hover:bg-indigo-700 transition-all duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed" data-i18n="addButton">
                    Add New Application
                </button>
                <div id="user-id-display" class="mt-2 text-xs text-gray-400 truncate w-40 text-center sm:w-auto sm:text-left" data-i18n="userIdDisplay">User ID: N/A</div>
            </div>
        </header>

        <!-- Main table -->
        <div class="overflow-x-auto rounded-xl border border-gray-200 shadow-sm">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="tableCompany">Company</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="tablePosition">Position</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="tableType">Type</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="tableAppliedOn">Applied On</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="tableStatus">Status</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="tableDeadline">Deadline</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="tableContact">Contact</th>
                        <th scope="col" class="relative px-6 py-3">
                            <span class="sr-only" data-i18n="tableActions">Actions</span>
                        </th>
                    </tr>
                </thead>
                <tbody id="applications-table-body" class="bg-white divide-y divide-gray-200">
                    <!-- Application rows will be rendered here dynamically -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal for adding/editing applications -->
    <div id="modal-container" class="modal fixed inset-0 z-50 flex items-center justify-center hidden p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 transform transition-all">
            <h2 id="modal-title" class="text-2xl font-bold text-gray-800 mb-4" data-i18n="modalAddTitle">Add New Application</h2>
            <form id="modal-form" class="space-y-4">
                <div>
                    <label for="companyName" class="block text-sm font-medium text-gray-700" data-i18n="modalCompanyName">Company Name</label>
                    <input type="text" id="companyName" name="companyName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="positionTitle" class="block text-sm font-medium text-gray-700" data-i18n="modalPositionTitle">Position Title</label>
                    <input type="text" id="positionTitle" name="positionTitle" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="applicationType" class="block text-sm font-medium text-gray-700" data-i18n="modalType">Application Type</label>
                    <select id="applicationType" name="applicationType" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="Internship" data-i18n="typeInternship">Internship</option>
                        <option value="Job" data-i18n="typeJob">Job</option>
                    </select>
                </div>
                <div>
                    <label for="applicationDate" class="block text-sm font-medium text-gray-700" data-i18n="modalAppliedDate">Date Applied</label>
                    <input type="date" id="applicationDate" name="applicationDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700" data-i18n="modalStatus">Status</label>
                    <select id="status" name="status" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="Applied" data-i18n="statusApplied">Applied</option>
                        <option value="Interviewing" data-i18n="statusInterviewing">Interviewing</option>
                        <option value="Offer" data-i18n="statusOffer">Offer</option>
                        <option value="Rejected" data-i18n="statusRejected">Rejected</option>
                    </select>
                </div>
                <div>
                    <label for="deadline" class="block text-sm font-medium text-gray-700" data-i18n="modalDeadline">Deadline (Optional)</label>
                    <input type="date" id="deadline" name="deadline" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="contactPerson" class="block text-sm font-medium text-gray-700" data-i18n="modalContactPerson">Contact Person (Optional)</label>
                    <input type="text" id="contactPerson" name="contactPerson" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancel-button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors" data-i18n="modalCancel">Cancel</button>
                    <button type="submit" id="submit-button" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 transition-colors" data-i18n="modalSave">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal-container" class="modal fixed inset-0 z-50 flex items-center justify-center hidden p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-xs p-6 text-center transform transition-all">
            <h3 class="text-xl font-bold text-gray-800 mb-2" data-i18n="modalConfirmTitle">Are you sure?</h3>
            <p class="text-sm text-gray-500 mb-6" data-i18n="modalConfirmText">This action cannot be undone.</p>
            <div class="flex justify-center space-x-3">
                <button id="cancel-confirm-button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors" data-i18n="modalConfirmCancel">Cancel</button>
                <button id="confirm-button" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 transition-colors" data-i18n="modalConfirmDelete">Delete</button>
            </div>
        </div>
    </div>

    <!-- Gemini Content Modal -->
    <div id="gemini-modal-container" class="modal fixed inset-0 z-50 flex items-center justify-center hidden p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-3xl p-6 transform transition-all">
            <h2 id="gemini-modal-title" class="text-2xl font-bold text-gray-800 mb-4" data-i18n="geminiModalTitle">Generated Content</h2>
            <textarea id="gemini-modal-content" class="w-full h-96 p-4 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none" readonly></textarea>
            <div class="flex justify-end mt-4">
                <button id="gemini-modal-close" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 transition-colors" data-i18n="geminiClose">Close</button>
            </div>
        </div>
    </div>
</body>
</html>
